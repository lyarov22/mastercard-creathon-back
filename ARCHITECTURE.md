# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã: –ü–æ—à–∞–≥–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã

## –û–±—â–∏–π –æ–±–∑–æ—Ä –ø—Ä–æ—Ü–µ—Å—Å–∞

```
–ö–ª–∏–µ–Ω—Ç ‚Üí FastAPI ‚Üí Text2SQL ‚Üí –í–∞–ª–∏–¥–∞—Ü–∏—è ‚Üí SQL Execution ‚Üí Streaming ‚Üí –ö–ª–∏–µ–Ω—Ç
```

---

## –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞

### üì• –®–ê–ì 1: –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞

**–§–∞–π–ª:** `app/server.py`  
**–§—É–Ω–∫—Ü–∏—è:** `process_text_stream()`

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**

1. **–ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç POST –∑–∞–ø—Ä–æ—Å** –Ω–∞ `/process-text`:
   ```json
   {
     "text": "–ü–æ–∫–∞–∂–∏ –≤—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü"
   }
   ```

2. **FastAPI –ø–æ–ª—É—á–∞–µ—Ç –∑–∞–ø—Ä–æ—Å** –∏ –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ middleware:
   - **CORS Middleware** - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç CORS –∑–∞–≥–æ–ª–æ–≤–∫–∏
   - **GZip Middleware** - —Å–∂–∏–º–∞–µ—Ç –æ—Ç–≤–µ—Ç—ã —Ä–∞–∑–º–µ—Ä–æ–º > 1000 –±–∞–π—Ç

3. **–í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:**
   ```python
   text = req.text.strip()  # –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–±–µ–ª–æ–≤
   if not text:
       raise HTTPException(status_code=400, ...)  # –û—à–∏–±–∫–∞ –µ—Å–ª–∏ –ø—É—Å—Ç–æ
   ```

4. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞:**
   ```python
   logger.info(f"Received text query: {text[:100]}...")
   ```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–æ–ª—É—á–µ–Ω –∏ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω —Ç–µ–∫—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

---

### ü§ñ –®–ê–ì 2: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è SQL –∏–∑ —Ç–µ–∫—Å—Ç–∞ (Text2SQL)

**–§–∞–π–ª:** `app/text2sql.py`  
**–§—É–Ω–∫—Ü–∏—è:** `Text2SQLGenerator.generate()`

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**

#### 2.1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (–ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞)

–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–µ—Ä–≤–µ—Ä–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è —ç–∫–∑–µ–º–ø–ª—è—Ä `Text2SQLGenerator`:
```python
engine = build_text2sql()  # –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
```

–≠—Ç–æ —Å–æ–∑–¥–∞–µ—Ç:
- –ö–ª–∏–µ–Ω—Ç Google Gemini API (`genai.Client`)
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –º–æ–¥–µ–ª—å: `gemini-2.5-flash`
- –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å—Ö–µ–º—É —Ç–∞–±–ª–∏—Ü—ã `transactions`

#### 2.2. –î–≤—É—Ö—à–∞–≥–æ–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è SQL

**–®–∞–≥ 2.2.1: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –Ω–∞–º–µ—Ä–µ–Ω–∏—è (Intent Extraction)**

```python
step1 = self._call(SYSTEM_PROMPT, ITER_1 + "\n" + nl_query)
```

**–ß—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ LLM:**
- `SYSTEM_PROMPT` - –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ SQL
- `ITER_1` - –∑–∞–ø—Ä–æ—Å –Ω–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∑–∞–ø—Ä–æ—Å–∞
- `nl_query` - —Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–ü—Ä–æ–º–ø—Ç ITER_1 –ø—Ä–æ—Å–∏—Ç –≤–µ—Ä–Ω—É—Ç—å JSON:**
```json
{
  "aggregation": "... or null",
  "target_columns": [...],
  "filters": [...],
  "order": "... or null",
  "limit": number or null,
  "time_range": { "from": "...", "to": "..." } or null
}
```

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ LLM:**
```json
{
  "aggregation": null,
  "target_columns": ["*"],
  "filters": ["transaction_timestamp >= NOW() - INTERVAL '1 month'"],
  "order": "transaction_timestamp DESC",
  "limit": 100000,
  "time_range": { "from": "2024-01-01", "to": "2024-02-01" }
}
```

**–®–∞–≥ 2.2.2: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è SQL**

```python
step2 = self._call(SYSTEM_PROMPT, ITER_2 + "\n" + step1)
```

**–ß—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ LLM:**
- `SYSTEM_PROMPT` - —Ç–µ –∂–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
- `ITER_2` - –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ SQL –∏–∑ JSON
- `step1` - JSON –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —à–∞–≥–∞

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ LLM:**
```sql
SELECT * 
FROM transactions 
WHERE transaction_timestamp >= NOW() - INTERVAL '1 month'
ORDER BY transaction_timestamp DESC
LIMIT 100000
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `temperature=0.0` –¥–ª—è –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏
- `max_output_tokens=5000` - –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª–∏–Ω—ã
- `top_p=0.95` - –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç LIMIT –µ—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–∏–º
- –ü–µ—Ä–µ–≤–æ–¥–∏—Ç —Ä—É—Å—Å–∫–∏–µ/–∫–∞–∑–∞—Ö—Å–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã –≤ –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –ë–î

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–æ–ª—É—á–µ–Ω SQL –∑–∞–ø—Ä–æ—Å –≤ –≤–∏–¥–µ —Å—Ç—Ä–æ–∫–∏.

---

### üîí –®–ê–ì 3: –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –æ—á–∏—Å—Ç–∫–∞ SQL

**–§–∞–π–ª:** `app/sql_validator.py`  
**–§—É–Ω–∫—Ü–∏—è:** `sanitize_and_validate()`

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**

#### 3.1. –û—á–∏—Å—Ç–∫–∞ SQL (`clean_sql()`)

```python
cleaned_sql, is_valid, error_msg = sanitize_and_validate(sql)
```

**–ü—Ä–æ—Ü–µ—Å—Å –æ—á–∏—Å—Ç–∫–∏:**

1. **–£–¥–∞–ª–µ–Ω–∏–µ markdown –±–ª–æ–∫–æ–≤:**
   ```python
   # –ï—Å–ª–∏ SQL –æ–±–µ—Ä–Ω—É—Ç –≤ ```sql ... ```
   if sql.startswith("```"):
       sql = sql.split("```")[1]  # –ò–∑–≤–ª–µ–∫–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
       if sql.startswith("sql"):
           sql = sql[3:]  # –£–¥–∞–ª—è–µ–º "sql"
   ```

2. **–£–¥–∞–ª–µ–Ω–∏–µ –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤:**
   ```python
   sql = sql.rstrip(';').strip()  # –£–±–∏—Ä–∞–µ–º —Ç–æ—á–∫—É —Å –∑–∞–ø—è—Ç–æ–π –∏ –ø—Ä–æ–±–µ–ª—ã
   ```

**–ü—Ä–∏–º–µ—Ä:**
```
–í—Ö–æ–¥:  ```sql\nSELECT * FROM transactions;\n```
–í—ã—Ö–æ–¥: SELECT * FROM transactions
```

#### 3.2. –í–∞–ª–∏–¥–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (`validate_sql()`)

**–ü—Ä–æ–≤–µ—Ä–∫–∏:**

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å:**
   ```python
   if not sql or not sql.strip():
       return False, "SQL query is empty"
   ```

2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:**
   ```python
   FORBIDDEN_KEYWORDS = {
       'DROP', 'DELETE', 'INSERT', 'UPDATE', 'ALTER', 
       'CREATE', 'TRUNCATE', 'EXEC', 'EXECUTE', ...
   }
   ```
   
   –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–æ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω–æ–µ —Å–ª–æ–≤–æ ‚Üí –æ—à–∏–±–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ –∑–∞–ø—Ä–æ—Å–∞:**
   ```python
   if not sql.upper().startswith(("SELECT", "WITH")):
       return False, "Only SELECT and WITH queries are allowed"
   ```
   
   –†–∞–∑—Ä–µ—à–µ–Ω—ã —Ç–æ–ª—å–∫–æ SELECT –∏ WITH –∑–∞–ø—Ä–æ—Å—ã (read-only)

4. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏:**
   ```python
   if sql.upper().count("SELECT") > 5:
       return False, "Query is too complex"
   ```
   
   –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ª–∏—à–∫–æ–º —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** 
- `cleaned_sql` - –æ—á–∏—â–µ–Ω–Ω—ã–π SQL
- `is_valid` - True/False
- `error_msg` - —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ (–µ—Å–ª–∏ –µ—Å—Ç—å)

**–ï—Å–ª–∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–µ –ø—Ä–æ—à–ª–∞:**
```python
if not is_valid:
    raise HTTPException(status_code=400, detail=f"Invalid SQL: {error_msg}")
```

---

### üóÑÔ∏è –®–ê–ì 4: –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ SQL –∑–∞–ø—Ä–æ—Å–∞ –∏ —Å—Ç—Ä–∏–º–∏–Ω–≥

**–§–∞–π–ª:** `app/sql_streamer.py`  
**–§—É–Ω–∫—Ü–∏—è:** `stream_select_query()`

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**

#### 4.1. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

```python
with engine.connect() as conn:
```

**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è connection pool:**
- `pool_size=20` - 20 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –≤ –ø—É–ª–µ
- `max_overflow=10` - –¥–æ 10 –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–∏ –Ω–∞–≥—Ä—É–∑–∫–µ
- `pool_pre_ping=True` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
- `pool_recycle=3600` - –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –∫–∞–∂–¥—ã–π —á–∞—Å

#### 4.2. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ —Å server-side cursor

```python
result = conn.execution_options(
    stream_results=True,      # Server-side cursor (–Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ –≤ –ø–∞–º—è—Ç—å)
    max_row_buffer=1000       # –ë—É—Ñ–µ—Ä –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
).execute(text(sql_query))
```

**–ß—Ç–æ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç:**
- `stream_results=True` - –¥–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –≤—Å–µ —Å—Ä–∞–∑—É –≤ –ø–∞–º—è—Ç—å
- PostgreSQL –¥–µ—Ä–∂–∏—Ç –∫—É—Ä—Å–æ—Ä –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- –î–∞–Ω–Ω—ã–µ —á–∏—Ç–∞—é—Ç—Å—è –ø–æ—Ä—Ü–∏—è–º–∏ –ø–æ –º–µ—Ä–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
- –≠–∫–æ–Ω–æ–º–∏—è –ø–∞–º—è—Ç–∏ –ø—Ä–∏ –±–æ–ª—å—à–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö

#### 4.3. –ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö

```python
columns = list(result.keys())  # –°–ø–∏—Å–æ–∫ –Ω–∞–∑–≤–∞–Ω–∏–π –∫–æ–ª–æ–Ω–æ–∫
# –ü—Ä–∏–º–µ—Ä: ['id', 'transaction_id', 'transaction_timestamp', ...]
```

#### 4.4. –ü–æ—Ç–æ–∫–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

```python
batch = []  # –ë—É—Ñ–µ—Ä –¥–ª—è –±–∞—Ç—á–∞

for row in result:  # –ò—Ç–µ—Ä–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–æ–∫–∞–º (–ª–µ–Ω–∏–≤–∞—è)
    # –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –≤ —Å–ª–æ–≤–∞—Ä—å
    row_dict = dict(zip(columns, row))
    # –ü—Ä–∏–º–µ—Ä: {'id': 1, 'transaction_id': 'TXN123', ...}
    
    batch.append(row_dict)
    
    # –ö–æ–≥–¥–∞ –Ω–∞–∫–æ–ø–∏–ª–æ—Å—å 10,000 –∑–∞–ø–∏—Å–µ–π - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –±–∞—Ç—á
    if len(batch) >= batch_size:
        yield json.dumps(batch, default=json_default, ensure_ascii=False) + "\n"
        batch.clear()  # –û—á–∏—â–∞–µ–º –±—É—Ñ–µ—Ä

# –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Å—Ç–∞—Ç–æ–∫ (–µ—Å–ª–∏ –µ—Å—Ç—å)
if batch:
    yield json.dumps(batch, default=json_default, ensure_ascii=False) + "\n"
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**

1. **JSON —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è:**
   ```python
   def json_default(obj):
       if isinstance(obj, (datetime, date)):
           return obj.isoformat()  # "2024-01-15T10:30:00"
       if isinstance(obj, Decimal):
           return float(obj)  # Decimal ‚Üí float
       return str(obj)
   ```

2. **–ë–∞—Ç—á–∏–Ω–≥:**
   - –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: 10,000 –∑–∞–ø–∏—Å–µ–π –Ω–∞ –±–∞—Ç—á
   - –ö–∞–∂–¥—ã–π –±–∞—Ç—á - –æ—Ç–¥–µ–ª—å–Ω—ã–π JSON –º–∞—Å—Å–∏–≤
   - –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ—Ä—Ü–∏—è–º–∏, –Ω–µ –¥–æ–∂–∏–¥–∞—è—Å—å –≤—Å–µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

3. **–û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤:**
   ```python
   finally:
       result.close()  # –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –∫—É—Ä—Å–æ—Ä–∞
   ```

**–ü—Ä–∏–º–µ—Ä –ø–æ—Ç–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö:**

```json
[{"id": 1, "amount": 100.5}, {"id": 2, "amount": 200.3}, ...]
[{"id": 10001, "amount": 150.2}, {"id": 10002, "amount": 250.8}, ...]
[{"id": 20001, "amount": 300.0}, ...]
```

–ö–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ - –æ—Ç–¥–µ–ª—å–Ω—ã–π JSON –º–∞—Å—Å–∏–≤ —Å –±–∞—Ç—á–µ–º –∑–∞–ø–∏—Å–µ–π.

---

### üì§ –®–ê–ì 5: –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞ –∫–ª–∏–µ–Ω—Ç—É

**–§–∞–π–ª:** `app/server.py`  
**–§—É–Ω–∫—Ü–∏—è:** `process_text_stream()`

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**

```python
return StreamingResponse(
    stream_select_query(cleaned_sql),  # –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –±–∞—Ç—á–µ–π
    media_type="application/json",
    headers={
        "X-Content-Type-Options": "nosniff",
        "Cache-Control": "no-cache"
    }
)
```

**StreamingResponse:**
- –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä (—Ñ—É–Ω–∫—Ü–∏—é —Å `yield`)
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—É –ø–æ –º–µ—Ä–µ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è
- –ù–µ –∂–¥–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
- –ö–ª–∏–µ–Ω—Ç –Ω–∞—á–∏–Ω–∞–µ—Ç –ø–æ–ª—É—á–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —Å—Ä–∞–∑—É

**HTTP –∑–∞–≥–æ–ª–æ–≤–∫–∏:**
- `Content-Type: application/json`
- `X-Content-Type-Options: nosniff` - –∑–∞—â–∏—Ç–∞ –æ—Ç MIME-sniffing
- `Cache-Control: no-cache` - –Ω–µ –∫–µ—à–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç

**GZip —Å–∂–∞—Ç–∏–µ:**
- Middleware –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∂–∏–º–∞–µ—Ç –æ—Ç–≤–µ—Ç—ã > 1000 –±–∞–π—Ç
- –£–º–µ–Ω—å—à–∞–µ—Ç —Ä–∞–∑–º–µ—Ä –ø–µ—Ä–µ–¥–∞—á–∏ –≤ 3-10 —Ä–∞–∑

---

## –ü–æ–ª–Ω–∞—è –≤—Ä–µ–º–µ–Ω–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞

```
–í—Ä–µ–º—è ‚Üí
‚îÇ
‚îú‚îÄ 0ms    : –ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç POST /process-text
‚îú‚îÄ 5ms    : FastAPI –ø–æ–ª—É—á–∞–µ—Ç –∑–∞–ø—Ä–æ—Å, –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç
‚îú‚îÄ 10ms   : –í—ã–∑–æ–≤ engine.generate(text)
‚îÇ
‚îú‚îÄ 15ms   : –®–∞–≥ 1 LLM: –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –≤ Gemini API
‚îú‚îÄ 500ms  : –®–∞–≥ 1 LLM: –ü–æ–ª—É—á–µ–Ω–∏–µ JSON —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
‚îÇ
‚îú‚îÄ 505ms  : –®–∞–≥ 2 LLM: –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –≤ Gemini API
‚îú‚îÄ 1000ms : –®–∞–≥ 2 LLM: –ü–æ–ª—É—á–µ–Ω–∏–µ SQL –∑–∞–ø—Ä–æ—Å–∞
‚îÇ
‚îú‚îÄ 1005ms : –í–∞–ª–∏–¥–∞—Ü–∏—è SQL (–æ—á–∏—Å—Ç–∫–∞ + –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)
‚îú‚îÄ 1010ms : –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î (–∏–∑ connection pool)
‚îú‚îÄ 1015ms : –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ SQL –Ω–∞ PostgreSQL
‚îÇ
‚îú‚îÄ 1020ms : –ù–∞—á–∞–ª–æ —Å—Ç—Ä–∏–º–∏–Ω–≥–∞ (–ø–µ—Ä–≤—ã–π –±–∞—Ç—á –≥–æ—Ç–æ–≤)
‚îÇ         : –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç –ø–µ—Ä–≤—ã–π –±–∞—Ç—á –¥–∞–Ω–Ω—ã—Ö
‚îÇ
‚îú‚îÄ 2000ms : –í—Ç–æ—Ä–æ–π –±–∞—Ç—á –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∫–ª–∏–µ–Ω—Ç—É
‚îú‚îÄ 3000ms : –¢—Ä–µ—Ç–∏–π –±–∞—Ç—á –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∫–ª–∏–µ–Ω—Ç—É
‚îÇ         : ...
‚îÇ
‚îî‚îÄ 5000ms : –ü–æ—Å–ª–µ–¥–Ω–∏–π –±–∞—Ç—á –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω, —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ
```

---

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### –û—à–∏–±–∫–∏ –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ:

1. **–í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:**
   ```python
   if not text:
       raise HTTPException(status_code=400, detail="Field 'text' is required")
   ```

2. **–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ SQL:**
   ```python
   if not sql or not sql.strip():
       raise HTTPException(status_code=400, detail="Failed to generate SQL")
   ```

3. **–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ SQL:**
   ```python
   if not is_valid:
       raise HTTPException(status_code=400, detail=f"Invalid SQL: {error_msg}")
   ```

4. **–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è SQL:**
   ```python
   except ValueError as e:
       raise HTTPException(status_code=400, detail=str(e))
   ```

5. **–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏:**
   ```python
   except Exception as e:
       logger.error(f"Unexpected error: {e}", exc_info=True)
       raise HTTPException(status_code=500, detail="Internal server error")
   ```

---

## –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ

### 1. Connection Pooling
- –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –∫ –ë–î
- –ù–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
- –£–º–µ–Ω—å—à–∞–µ—Ç –∑–∞–¥–µ—Ä–∂–∫—É –Ω–∞ 50-100ms

### 2. Server-side Cursor
- –î–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –≤—Å–µ –≤ –ø–∞–º—è—Ç—å
- –†–∞–±–æ—Ç–∞–µ—Ç —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –ª—é–±–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
- –≠–∫–æ–Ω–æ–º–∏—è –ø–∞–º—è—Ç–∏ –≤ 10-100 —Ä–∞–∑

### 3. –ë–∞—Ç—á–∏–Ω–≥
- –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ—Ä—Ü–∏—è–º–∏ –ø–æ 10,000 –∑–∞–ø–∏—Å–µ–π
- –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –±—ã—Å—Ç—Ä–µ–µ
- –ú–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–µ—Ç—å

### 4. GZip —Å–∂–∞—Ç–∏–µ
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∂–∞—Ç–∏–µ –æ—Ç–≤–µ—Ç–æ–≤
- –£–º–µ–Ω—å—à–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –≤ 3-10 —Ä–∞–∑
- –ë—ã—Å—Ç—Ä–µ–µ –ø–µ—Ä–µ–¥–∞—á–∞ –ø–æ —Å–µ—Ç–∏

### 5. –î–≤—É—Ö—à–∞–≥–æ–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è SQL
- –õ—É—á—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ SQL
- –ë–æ–ª–µ–µ —Ç–æ—á–Ω–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ –Ω–∞–º–µ—Ä–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π LIMIT, –∞–≥—Ä–µ–≥–∞—Ü–∏—è)

---

## –ü—Ä–∏–º–µ—Ä –ø–æ–ª–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞

### –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
```json
{
  "text": "–ü–æ–∫–∞–∂–∏ –≤—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ –ê–ª–º–∞—Ç—ã –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ —Å—É–º–º–µ"
}
```

### –®–∞–≥ 1: LLM –∏–∑–≤–ª–µ–∫–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É
```json
{
  "target_columns": ["*"],
  "filters": [
    "merchant_city = 'Almaty'",
    "transaction_timestamp >= NOW() - INTERVAL '1 month'"
  ],
  "order": "transaction_amount_kzt DESC",
  "limit": 100000
}
```

### –®–∞–≥ 2: LLM –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç SQL
```sql
SELECT * 
FROM transactions 
WHERE merchant_city = 'Almaty' 
  AND transaction_timestamp >= NOW() - INTERVAL '1 month'
ORDER BY transaction_amount_kzt DESC
LIMIT 100000
```

### –®–∞–≥ 3: –í–∞–ª–∏–¥–∞—Ü–∏—è
‚úÖ –ü—Ä–æ—Ö–æ–¥–∏—Ç –≤—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### –®–∞–≥ 4: –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏ —Å—Ç—Ä–∏–º–∏–Ω–≥
```json
[{"id": 1, "merchant_city": "Almaty", "amount": 50000, ...}, ...]
[{"id": 10001, "merchant_city": "Almaty", "amount": 45000, ...}, ...]
...
```

### –®–∞–≥ 5: –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ
–ö–ª–∏–µ–Ω—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –±–∞—Ç—á–∏ –ø–æ –º–µ—Ä–µ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è, –Ω–µ –¥–æ–∂–∏–¥–∞—è—Å—å –≤—Å–µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞.

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è:
- ‚ö° –ë—ã—Å—Ç—Ä–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
- üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (–≤–∞–ª–∏–¥–∞—Ü–∏—è SQL)
- üíæ –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏ (streaming)
- üìä –†–∞–±–æ—Ç—ã —Å –±–æ–ª—å—à–∏–º–∏ –æ–±—ä–µ–º–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö
- üåê –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç–∏ (connection pooling)

